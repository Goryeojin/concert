# 대기열 시스템 Redis 이관

## 1. AS-IS
현재 시스템은 RDB 를 메인 데이터베이스로 사용하여 대기열 시스템을 관리한다.

1. 대기열 토큰 생성 및 인입
   1. 사용자가 대기열 토큰 생성 요청을 보낸다.
   2. 기존 토큰이 있는지 RDB에서 조회하고, 있는 경우 만료시킨다.
   3. 활성 토큰의 개수를 조회하여 50개 미만인 경우 활성화된 토큰을 발급하고, 이상인 경우 대기 상태의 토큰을 발급 받는다.

2. 대기열 토큰 정보 조회
   1. 사용자가 대기열 정보 조회 요청을 보낸다.
   2. RDB 에서 토큰 정보를 조회하고 반환한다.
   3. 만료된 토큰일 경우 401 에러를 반환한다.
   4. 대기 상태의 토큰일 경우 대기자 수를 조회하여 반환한다.

3. 대기열 -> 활성 이동
   1. 스케쥴러를 사용한다.
   2. 활성 상태의 토큰의 수를 조회한다.
   3. 50개 미만일 경우 필요 수 만큼 대기 중인 토큰을 조회한다.
   4. 대기 중인 토큰의 상태를 활성 상태로 변경한다.

4. 만료 토큰 처리
   1. 활성화된 토큰의 만료 시간을 조회한다.
   2. 현재 시간보다 이전일 경우 만료 상태로 변경한다.

5. 결제 완료
   1. 결제가 완료되면 요청 시 받은 활성 토큰의 상태를 만료시킨다.

## 2. TO-BE
### Redis 이관에 대한 변경 사항

### 1. **대기열 관리: RDB -> Redis의 Sorted Set**
- **변경 사항**: 기존에 RDB에서 관리하던 대기열 시스템을 Redis의 `Sorted Set`을 이용하여 처리한다. Redis `Sorted Set`은 순차적으로 데이터를 정렬하며 관리할 수 있기 때문에 대기열의 순번 계산과 빠른 조회가 가능해진다. 이로 인해 대기열에 토큰을 추가할 때 자동으로 순위가 매겨지며, 대기 상태의 토큰을 빠르게 관리할 수 있다.
- **장점**:
    - `Sorted Set`은 데이터의 순서가 자연스럽게 유지되므로 대기 상태의 토큰 순번을 계산하는데 용이하다.
    - Redis는 메모리 기반의 데이터베이스로 빠른 읽기/쓰기를 제공하므로 대기열 관련 작업의 성능이 향상된다.

### 2. **활성 토큰 관리: RDB -> Redis의 Hashes**
- **변경 사항**: 활성 토큰은 Redis의 `Hashes` 자료형을 사용하여 관리한다. 토큰값 등을 Hash 값으로 저장하여 빠른 조회가 가능하다.
- **장점**:
    - `Hashes`를 이용하면 토큰을 효율적으로 저장하고 빠르게 업데이트할 수 있다.
    - 활성 토큰의 상태를 Redis에서 실시간으로 변경할 수 있어 더 이상 RDB에서 관리할 필요가 없다.

### 3. **만료 토큰 처리: 스케쥴링 -> Redis TTL 설정으로 자동 만료**
- **변경 사항**: 기존에 스케쥴러를 이용하여 만료된 토큰을 처리하던 방식에서, Redis의 TTL(Time To Live) 기능을 이용하여 자동으로 만료되도록 변경한다. Redis에서 데이터를 저장할 때 TTL을 설정하면, 해당 시간이 지나면 자동으로 데이터가 삭제된다.
- **장점**:
    - 스케쥴러를 따로 관리할 필요가 없고, Redis가 TTL을 자동으로 처리하므로 관리가 단순해진다.
    - 만료된 데이터를 실시간으로 관리할 수 있어 시스템의 일관성 유지에 도움이 된다.

### 4. **카운터 관리: RDB -> 활성 토큰 추적 시 Redis로 카운팅**
- **변경 사항**: HLEN 명령어를 사용하여 Redis에서 관리하는 활성 토큰의 개수를 빠르고 효율적으로 조회한다.
- **장점**:
    - Hash의 필드 개수를 카운트하는 방식은 INCR/DECR 방식에 비해 복잡한 카운팅 작업을 줄일 수 있고, 실시간으로 토큰의 개수를 확인하는 데 유리하다.

### 5. **순번 계산: RDB -> Redis Sorted Set의 Rank**
- **변경 사항**: 대기열 토큰의 순번 계산을 Redis `Sorted Set`의 `rank`를 이용하여 처리한다. Redis `Sorted Set`은 순서대로 정렬되어 저장되므로, 각 토큰의 순번을 자동으로 계산할 수 있다..
- **장점**:
    - `Sorted Set`의 `rank` 명령어를 이용하여 토큰의 순번을 매우 효율적으로 계산할 수 있다.
    - RDB에서 순번을 관리할 때 발생할 수 있는 성능 문제를 해결할 수 있다.
